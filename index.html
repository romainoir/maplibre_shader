<!DOCTYPE html>
<html lang="en">
<head>
  <title>Advanced Terrain Shading with SunCalc</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- MapLibre GL -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.11.0/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@5.11.0/dist/maplibre-gl.js"></script>
  <!-- SunCalc library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
  <style>
    html, body, #map { margin: 0; padding: 0; height: 100%; }

    :root {
      --glass-border: rgba(255, 255, 255, 0.35);
      --glass-highlight: rgba(255, 255, 255, 0.6);
      --glass-shadow: rgba(6, 8, 12, 0.3);
      --glass-panel-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.32), rgba(255, 255, 255, 0.08));
      --accent: #ff9f5c;
      --accent-strong: #ff7b39;
    }

    body {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #1f2958 0%, #0b1122 55%, #050812 100%);
      color: #f8fbff;
      overflow: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 480px;
      height: 480px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0) 60%);
      filter: blur(30px);
      opacity: 0.6;
      pointer-events: none;
      z-index: 1;
    }

    body::before { top: -120px; left: -80px; }
    body::after { bottom: -150px; right: -100px; }

    #topControls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      padding: 12px 16px;
      border-radius: 18px;
      background: linear-gradient(130deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.05));
      border: 1px solid var(--glass-border);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45), 0 25px 60px rgba(3, 6, 16, 0.55);
      backdrop-filter: blur(18px);
      transform: translateZ(0);
    }

    .control-button {
      padding: 10px 18px;
      font-size: 13px;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.04));
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.22);
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.25s ease, transform 0.2s ease, box-shadow 0.25s ease;
      box-shadow: 0 8px 25px rgba(6, 10, 25, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(18px);
    }

    .control-button:hover {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.05));
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(6, 10, 25, 0.55);
    }

    .control-button.active {
      background: linear-gradient(145deg, var(--accent), var(--accent-strong));
      border-color: rgba(255, 255, 255, 0.4);
      box-shadow: 0 15px 30px rgba(255, 128, 80, 0.55), inset 0 1px 0 rgba(255, 255, 255, 0.45);
    }

    .control-checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: linear-gradient(130deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.05));
      border-radius: 14px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45), 0 10px 30px rgba(0, 0, 0, 0.35);
      border: 1px solid var(--glass-border);
      font-size: 13px;
      color: #fff;
      backdrop-filter: blur(20px);
    }

    .control-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }

    .control-checkbox label {
      cursor: pointer;
      font-weight: 600;
    }

    #layersPanel {
      position: absolute;
      top: 80px;
      left: 10px;
      width: 320px;
      z-index: 11;
      display: none;
      flex-direction: column;
      gap: 12px;
      padding: 20px;
      border-radius: 26px;
      background: var(--glass-panel-bg);
      color: #fff;
      box-shadow: 0 25px 60px rgba(3, 6, 16, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(28px);
      transform-origin: top left;
      animation: floatIn 0.5s ease forwards;
    }

    #layersPanel.open {
      display: flex;
    }

    #layersPanel h3 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    #layersPanel .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    #layersPanel .panel-close {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      padding: 4px 10px;
      border-radius: 999px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
      transition: transform 0.2s ease;
    }

    #layersPanel .panel-close:hover { transform: rotate(90deg) scale(1.1); }

    #layersPanel .button-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    #layersPanel .button-grid .control-button {
      width: 100%;
      box-shadow: none;
    }

    #layersPanel .panel-section {
      display: none;
      flex-direction: column;
      gap: 8px;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0));
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    #layersPanel label {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #layersPanel input[type="range"] {
      width: 100%;
    }

    #layersPanel span {
      font-variant-numeric: tabular-nums;
    }

    #customShaderBtn {
      font-weight: 600;
    }

    #shadowControls {
      gap: 8px;
    }

    #shadowControls > div {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="range"] {
      vertical-align: middle;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.2);
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(145deg, var(--accent), var(--accent-strong));
      border: 2px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.35);
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(145deg, var(--accent), var(--accent-strong));
      border: 2px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.35);
      cursor: pointer;
    }

    @keyframes floatIn {
      from { transform: scale(0.96) translateY(8px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
    }

    #customShaderModal {
      position: fixed;
      inset: 0;
      background: rgba(4, 7, 15, 0.65);
      backdrop-filter: blur(6px);
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }

    #customShaderModal.open {
      display: flex;
    }

    #customShaderModal .modal-content {
      width: min(900px, 90vw);
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 16px;
      border-radius: 28px;
      background: var(--glass-panel-bg);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 35px 80px rgba(5, 6, 20, 0.65);
      padding: 26px;
      color: #fff;
      animation: floatIn 0.45s ease forwards;
    }

    #customShaderModal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    #customShaderModal .modal-header h3 {
      margin: 0;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 15px;
    }

    #customShaderModal .modal-header button {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 999px;
      color: #fff;
      font-size: 18px;
      line-height: 1;
      width: 36px;
      height: 36px;
      cursor: pointer;
    }

    #customShaderModal p {
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }

    #customShaderModal .modal-hint {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
    }

    #customShaderInput {
      width: 100%;
      min-height: 320px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(5, 7, 18, 0.85);
      color: #f8fbff;
      padding: 16px;
      font-family: 'JetBrains Mono', 'SFMono-Regular', Consolas, 'Liberation Mono', monospace;
      font-size: 13px;
      line-height: 1.45;
      resize: vertical;
    }

    #customShaderInput:focus {
      outline: 2px solid var(--accent);
      outline-offset: 4px;
    }

    .custom-shader-footer {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
    }

    #customShaderStatus {
      min-height: 20px;
      font-size: 13px;
    }

    #customShaderStatus.error {
      color: #ff9f5c;
    }

    .custom-shader-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .custom-layer-cheatsheet {
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(5, 7, 18, 0.55);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      font-size: 13px;
    }

    .custom-layer-cheatsheet h4 {
      margin: 0 0 6px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.85);
    }

    .custom-layer-cheatsheet ul {
      margin: 0;
      padding-left: 18px;
      list-style: disc;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .custom-layer-cheatsheet li {
      line-height: 1.35;
    }

    .control-button.secondary {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }
    .control-button.secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }
  </style>
</head>
<body>
  <div id="topControls">
    <div class="control-checkbox">
      <input id="hqMode" type="checkbox">
      <label for="hqMode">HQ (LOD 3/9)</label>
    </div>
    <button id="layersToggle" class="control-button" aria-expanded="false" aria-controls="layersPanel">Layers</button>
    <button id="customShaderBtn" class="control-button" type="button">Custom Shader</button>
  </div>
  <div id="layersPanel" aria-hidden="true">
    <div class="panel-header">
      <h3>Layers</h3>
      <button id="layersClose" class="panel-close" type="button" aria-label="Close layers panel">×</button>
    </div>
    <div class="button-grid">
      <button id="hillShadeNativeBtn" class="control-button">HillShade Native</button>
      <button id="hillShadeCustomBtn" class="control-button">HillShade Custom</button>
      <button id="normalBtn" class="control-button">Normal</button>
      <button id="avalancheBtn" class="control-button">Avalanche</button>
      <button id="slopeBtn" class="control-button">Slope</button>
      <button id="aspectBtn" class="control-button">Orientation</button>
      <button id="snowBtn" class="control-button">Snow</button>
      <button id="shadowBtn" class="control-button">Shadow</button>
      <button id="daylightBtn" class="control-button">Sunlight</button>
    </div>
    <div id="snowSliderContainer" class="panel-section">
      <label for="snowAltitudeSlider">Snow Altitude</label>
      <input type="range" id="snowAltitudeSlider" min="0" max="5000" step="50" value="3000">
      <span id="snowAltitudeValue">3000</span>
      <label for="snowSlopeSlider">Max Slope (°)</label>
      <input type="range" id="snowSlopeSlider" min="0" max="90" step="1" value="55">
      <span id="snowSlopeValue">55</span>
      <label for="snowBlurSlider">Snow Blur</label>
      <input type="range" id="snowBlurSlider" min="0" max="2" step="0.05" value="1">
      <span id="snowBlurValue">1.00</span>
    </div>
    <div id="shadowControls" class="panel-section">
      <div>
        <label for="shadowDateSlider">Date</label>
        <input type="range" id="shadowDateSlider" min="0" max="364" step="1">
        <span id="shadowDateValue"></span>
      </div>
      <div>
        <label for="shadowTimeSlider">Time</label>
        <input type="range" id="shadowTimeSlider" min="0" max="1439" step="1">
        <span id="shadowTimeValue"></span>
      </div>
      <div>
        <label for="shadowMaxOpacitySlider">Max Opacity</label>
        <input type="range" id="shadowMaxOpacitySlider" min="0.2" max="1" step="0.01" value="0.9">
        <span id="shadowMaxOpacityValue">0.90</span>
      </div>
    </div>
  </div>
  <div id="customShaderModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="customShaderTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="customShaderTitle">Custom Shader Layer</h3>
        <button id="customShaderClose" type="button" aria-label="Close custom shader editor">×</button>
      </div>
      <p>Paste GLSL fragment code below. The editor automatically prepends MapLibre's terrain varyings and helper functions so you can access <code>v_texCoord</code>, <code>v_elevation</code>, <code>getElevationFromTexture</code>, <code>getHillshadeGradient</code>, neighbor samplers, and more.</p>
      <p class="modal-hint">Write a <code>void main()</code> function that sets <code>fragColor</code>. Gradient and depth textures are available, and new code is applied live.</p>
      <div class="custom-layer-cheatsheet" aria-label="Custom layer arguments reference">
        <div>
          <h4>customLayerArgs</h4>
          <ul>
            <li><code>nearZ</code> / <code>farZ</code> – camera clipping planes in meters.</li>
            <li><code>fov</code> – vertical field of view already converted to radians.</li>
            <li><code>modelViewProjectionMatrix</code> &amp; <code>projectionMatrix</code> – the 4×4 matrices used for projecting world space into clip space.</li>
            <li><code>shaderData</code> – projection metadata ({ <code>variantName</code>, <code>vertexShaderPrelude</code>, <code>define</code> }) injected ahead of your shader.</li>
            <li><code>defaultProjectionData</code> – value from <code>transform.getProjectionDataForCustomLayer()</code> for globe/mercator helpers.</li>
          </ul>
        </div>
        <div>
          <h4>renderingMode</h4>
          <ul>
            <li><code>'3d'</code> – reads and writes depth via <code>painter.getDepthModeFor3D()</code> so geometry participates in terrain occlusion.</li>
            <li><code>'2d'</code> (default) – depth is read-only, ideal for full-screen quads like skies or screen-space compositing.</li>
          </ul>
        </div>
      </div>
      <textarea id="customShaderInput" spellcheck="false"></textarea>
      <div class="custom-shader-footer">
        <div id="customShaderStatus" aria-live="polite"></div>
        <div class="custom-shader-actions">
          <button id="customShaderDisable" type="button" class="control-button secondary">Disable Layer</button>
          <button id="customShaderCancel" type="button" class="control-button secondary">Cancel</button>
          <button id="customShaderApply" type="button" class="control-button">Apply Shader</button>
        </div>
      </div>
    </div>
  </div>
  <div id="map"></div>
  <!-- Include shader definitions and debugging helpers -->
  <script src="maplibre-hillshade-debug.js"></script>
  <script src="custom-shaders/hillshade.js"></script>
  <script src="custom-shaders/normal.js"></script>
  <script src="custom-shaders/avalanche.js"></script>
  <script src="custom-shaders/slope.js"></script>
  <script src="custom-shaders/aspect.js"></script>
  <script src="custom-shaders/snow.js"></script>
  <script src="custom-shaders/shadow.js"></script>
  <script src="custom-shaders/daylight.js"></script>
  <script src="terrain-shaders.js"></script>
  <script src="h4-sunlight-engine.js"></script>
  <!-- Main application script -->
  <script defer src="terrain-analysis.js"></script>
</body>
</html>

